<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="robots" content="noindex,nofollow" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://unpkg.com" />
  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    :root{--gap:14px;--fg:#111;--muted:#666;--bd:#dcdcdc;--bg:#fafafa}
    *{box-sizing:border-box}
    body{font-family:system-ui,Segoe UI,Roboto,sans-serif;color:var(--fg);margin:0}
    .container{max-width:880px;margin:24px auto 64px;padding:0 16px}
    .card{background:var(--bg);border:1px solid var(--bd);border-radius:14px;padding:20px}
    .row{display:grid;grid-template-columns:1fr;gap:var(--gap);margin:0 0 var(--gap)}
    .two{grid-template-columns:1fr 1fr}
    @media(max-width:720px){.two{grid-template-columns:1fr}}

    label{font-size:14px;color:var(--muted)}
    input,select,textarea{width:100%;padding:12px;font-size:16px;border:1px solid var(--bd);border-radius:10px;background:#fff}
    textarea{min-height:84px;resize:vertical}

    /* Encabezado */
    .headerline{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .headerline h2{margin:0}
    .badge{font-size:11px;padding:2px 6px;border-radius:6px;border:1px solid var(--bd);color:#555}

    /* Barra de modos (izquierda) */
    .modebar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:10px 0 6px}
    .pill,.toggle{padding:8px 14px;border-radius:999px;border:1px solid var(--bd);background:#fff;cursor:pointer;user-select:none}
    .pill.active,.toggle.active{background:#111;color:#fff;border-color:#111}
    .modehint{margin:2px 0 12px;color:var(--muted);font-size:12px}

    #product{background:#fff;border:1px dashed var(--bd);border-radius:10px;padding:10px;font-size:14px;color:#333}
    #status{min-height:26px;font-size:15px;margin-top:6px}

    .actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    button{padding:12px 18px;font-size:16px;border-radius:10px;border:1px solid #111;background:#111;color:#fff;cursor:pointer}
    button.secondary{background:#fff;color:#111}
    button:disabled{opacity:.6;cursor:not-allowed}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}

    #scanBar{display:flex;align-items:center;gap:10px;flex-wrap:wrap}

    /* Visor ‚Äúbanda‚Äù 1D incrustado */
    #reader{
      position:relative; z-index:10; width:100%; max-width:720px;
      height:0; overflow:hidden; border:1px solid var(--bd); border-radius:10px;
      background:#000; margin:8px auto 12px; display:none;
    }
    #reader video,#reader canvas,#reader .html5-qrcode-element,
    #reader #qr-shaded-region,#reader #reader__scan_region{width:100%!important;height:100%!important}
    #reader video{object-fit:cover}
    #reader__dashboard{display:none!important}
    @media (max-width:520px){#reader{max-width:100%}}

    .led{width:12px;height:12px;border-radius:50%;border:1px solid #ccc;display:inline-block}
    .led.red{background:#e03a3a}.led.green{background:#19a34a}.led.gray{background:#bbb}
    .inline{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .muted{color:#666;font-size:14px}
    .alert{background:#ffe9e9;border:1px solid #ffb3b3;color:#9b1c1c;border-radius:10px;padding:10px;font-size:14px}
    .hint{color:#a33;font-size:12px;margin-top:6px}
  </style>
</head>
<body>
  <div id="app-root"></div>

  <script>
  /* ==== API (/exec) ==== */
  const API = 'https://script.google.com/macros/s/AKfycbwKn4L6psOtM778jC9rPrJt1tAzopLBEBs8asLiWLVRX9iFF6iIc3XpzLvsZfqsMsYiAw/exec';

  const $e = (sel,root=document)=>root.querySelector(sel);
  const el = {};
  document.getElementById('app-root').innerHTML = `
  <div class="container"><div class="card">

    <div class="headerline">
      <h2>Sector Espera ‚Äì Movimientos</h2>
      <span id="apiBadge" class="badge">API‚Ä¶</span>
    </div>

    <!-- Barra de modos a la izquierda -->
    <div class="modebar">
      <span class="pill" id="btnIng">Ingreso</span>
      <span class="pill" id="btnEgr">Egreso</span>
      <span id="btnAuto" class="toggle" role="button" aria-pressed="false">Autom√°tico</span>
    </div>
    <div class="modehint">
      Seleccion√° <b>Ingreso</b> o <b>Egreso</b> para registrar. Activ√° <b>Autom√°tico</b> si no requer√≠s carga manual de datos.
    </div>

    <div class="row two">
      <div>
        <label>Estado</label>
        <select id="estado">
          <option>Listo</option><option>Mecanizar</option><option>Rechazado</option><option>Reproceso</option>
        </select>
      </div>
      <div>
        <label>Responsable</label>
        <select id="resp"><option value="">-- Seleccionar --</option></select>
        <div id="respError" class="hint" style="display:none"></div>
      </div>
    </div>

    <div class="row">
      <div>
        <label>C√≥digo o Modelo</label>
        <input id="key" placeholder="Escane√° o escrib√≠ el C√≥digo/Modelo" />
      </div>
    </div>

    <div class="row"><div id="product"></div></div>

    <div class="row">
      <div id="scanBar">
        <button class="secondary" id="scanStart">üì∑ Escanear</button>
        <button class="secondary" id="scanStop">‚úã Parar</button>
        <button class="secondary" id="scanClear">üóëÔ∏è Borrar</button>
        <span id="scanLed" class="led gray"></span>
        <small id="scanMsg" class="mono muted">C√°mara inactiva</small>
      </div>
      <div id="reader"></div>
    </div>

    <div class="row two">
      <div>
        <label>Contar por</label>
        <select id="contarPor"><option value="u">Unidades</option><option value="c">Cajas</option></select>
      </div>
      <div class="inline">
        <div style="flex:1"><label>Cantidad</label><input id="cantidad" type="number" min="1" step="1" value="1" /></div>
        <div><label>Total unidades</label><input id="totalUnid" type="number" readonly value="1" /></div>
      </div>
    </div>

    <div class="row" id="alertUxCaja" style="display:none">
      <div class="alert">Este modelo no tiene <b>Unidades_por_caja</b>. Cambi√° a <b>Unidades</b> o completalo en la hoja.</div>
    </div>

    <div class="row"><div><label>OC (opcional)</label><input id="oc" /></div></div>
    <div class="row"><div><label>OPI (opcional)</label><input id="opi" /></div></div>
    <div class="row"><div><label>Observaciones (opcional)</label><textarea id="obs" rows="2"></textarea></div></div>

    <div class="row"><div class="actions"><button id="enviar">‚úì Registrar</button></div><div id="status"></div></div>
  </div></div>
  `;

  const MOV = {val:'Ingreso'}; let AUTO=false, lastFicha=null, qr=null, scanning=false;
  [
    'btnIng','btnEgr','btnAuto','estado','key','product','scanStart','scanStop','scanClear',
    'scanLed','scanMsg','reader','contarPor','cantidad','totalUnid','alertUxCaja','oc','opi','obs','resp','enviar','status','respError','apiBadge'
  ].forEach(id=>el[id]=$e('#'+id));

  /* Movimiento */
  function setMov(m){MOV.val=m; el.btnIng.classList.toggle('active',m==='Ingreso'); el.btnEgr.classList.toggle('active',m==='Egreso');}
  el.btnIng.onclick=()=>setMov('Ingreso'); el.btnEgr.onclick=()=>setMov('Egreso'); setMov('Ingreso');

  /* Autom√°tico */
  el.btnAuto.onclick=()=>{ if(el.btnAuto.classList.contains('disabled')) return; AUTO=!AUTO; el.btnAuto.classList.toggle('active',AUTO); el.btnAuto.setAttribute('aria-pressed',AUTO?'true':'false'); };

  /* Totales */
  function disableAuto(dis,why=''){ if(dis){AUTO=false; el.btnAuto.classList.remove('active'); el.btnAuto.classList.add('disabled'); el.btnAuto.style.opacity=.6; el.btnAuto.title=why;} else {el.btnAuto.classList.remove('disabled'); el.btnAuto.style.opacity=1; el.btnAuto.title='';}}
  function toggleAvisoUxCaja(show){ el.alertUxCaja.style.display=show?'':'none'; disableAuto(show,'Falta Unidades_por_caja'); }
  function calcTotal(){ const modo=el.contarPor.value, cant=Math.max(1,parseInt(el.cantidad.value||'1',10)); const uxc=Number(lastFicha?.unidades_por_caja||0); let total=cant; if(modo==='c'){ if(uxc>0){ total=cant*uxc; toggleAvisoUxCaja(false);} else { toggleAvisoUxCaja(true);} } else toggleAvisoUxCaja(false); el.totalUnid.value=total; return total; }
  el.contarPor.onchange=calcTotal; el.cantidad.oninput=calcTotal;

  /* ===== Fetch helpers (CORS + anti-cache) ===== */
  function antiCache(path){ return API + path + (path.includes('?')?'&':'?') + 't=' + Date.now(); }
  async function apiGet(path){
    const r = await fetch(antiCache(path), { method:'GET', mode:'cors', cache:'no-store', redirect:'follow', headers:{'Accept':'application/json'} });
    const tx = await r.text(); try { return JSON.parse(tx); } catch { return { ok:false, error:'NON_JSON', raw: tx.slice(0,200) }; }
  }
  async function apiPost(body){
    const r = await fetch(antiCache(''), { method:'POST', mode:'cors', cache:'no-store', redirect:'follow', headers:{'Content-Type':'application/json','Accept':'application/json'}, body: JSON.stringify(body) });
    const tx = await r.text(); try { return JSON.parse(tx); } catch { return { ok:false, error:'NON_JSON', raw: tx.slice(0,200) }; }
  }

  /* Ping + responsables */
  (async ()=>{
    const ping = await apiGet('?action=ping');
    el.apiBadge.textContent = ping?.ok ? 'API OK' : 'API ERROR';
    el.apiBadge.style.color = ping?.ok ? '#0a0' : '#a00';

    const u = await apiGet('?action=users');
    if(u.ok && Array.isArray(u.responsables)){
      u.responsables.forEach(n=>{ const o=document.createElement('option'); o.value=o.textContent=n; el.resp.appendChild(o); });
      el.respError.style.display='none';
    }else{
      el.respError.style.display=''; el.respError.textContent = 'No se pudo cargar responsables' + (u?.error?` (${u.error})`:'') + (u?.raw ? ' ¬∑ pista: ' + u.raw.replace(/\s+/g,' ').slice(0,80) : '');
    }
  })();

  /* Lookup producto */
  let lookupTimer=null;
  el.key.addEventListener('input',()=>{ clearTimeout(lookupTimer); lookupTimer=setTimeout(lookupProduct,200); });
  async function lookupProduct(){
    const key=el.key.value.trim();
    if(!key){ el.product.innerHTML=''; lastFicha=null; calcTotal(); return; }
    el.product.textContent='Buscando‚Ä¶';
    const j=await apiGet('?action=lookup&key='+encodeURIComponent(key));
    if(j.ok){
      lastFicha=j.ficha;
      const desc = j.ficha.descripcion ? `<br><b>Descripci√≥n:</b> ${j.ficha.descripcion}` : '';
      const uxc  = j.ficha.unidades_por_caja ? (' | U/Caja: '+j.ficha.unidades_por_caja) : '';
      el.product.innerHTML = `<small class="mono">Modelo: <b>${j.ficha.modelo}</b> | C√≥digo: <b>${j.ficha.codigo}</b><br>Material: ${j.ficha.material} | Color: ${j.ficha.color} | Medidas: ${j.ficha.medidas}${uxc}${desc}</small>`;
    } else { lastFicha=null; el.product.innerHTML='<small style="color:#b00">No encontrado en Maestros</small>'; }
    calcTotal();
  }

  /* ===== C√ÅMARA (embebida) ===== */
  function setLed(state,msg){ el.scanLed.className='led '+(state||'gray'); el.scanMsg.textContent=msg||''; }
  function onScan(txt){ (async ()=>{ el.key.value=txt.trim(); await new Promise(r=>setTimeout(r,10)); await lookupProduct(); setLed('green','C√≥digo le√≠do'); const aviso=el.alertUxCaja.style.display!=='none'; if(AUTO && !aviso){ enviar(true);} else { await stop(); }})(); }
  function onError(_){}

  el.scanStart.onclick = async () => {
    try{
      const cardW = el.reader.parentElement.getBoundingClientRect().width || 720;
      const contW = Math.max(320, Math.min(cardW, 720));
      const boxW  = Math.min(Math.floor(contW * 0.85), 640);
      const boxH  = Math.max(80, Math.round(boxW * 0.22));

      el.reader.style.display = '';
      el.reader.style.width   = contW + 'px';
      el.reader.style.height  = boxH  + 'px';

      if (qr) { try{ await qr.stop(); await qr.clear(); }catch(_){} }

      qr = new Html5Qrcode('reader', { verbose:false });
      setLed('gray','Solicitando c√°mara‚Ä¶');

      const cams = await Html5Qrcode.getCameras();
      if(!cams || !cams.length){ setLed('red','No se encontr√≥ c√°mara'); await stop(); return; }
      const back = cams.find(c=>/back|rear|environment|trasera/i.test(c.label||'')) || cams[0];

      await qr.start(
        { deviceId:{ exact: back.id || back } },
        { fps:12, qrbox:{ width:boxW, height:boxH }, experimentalFeatures:{ useBarCodeDetectorIfSupported:true }, videoConstraints:{ facingMode:'environment' } },
        onScan, onError
      );
      scanning = true; setLed('gray','Escaneando‚Ä¶');
    }catch(e){ setLed('red','No se pudo iniciar la c√°mara'); await stop(); }
  };

  async function stop(){
    try{ if(qr && scanning){ await qr.stop(); } if(qr){ await qr.clear(); } scanning=false; }catch(_){}
    el.reader.style.height='0px'; el.reader.style.display='none'; setLed('gray','C√°mara inactiva');
  }
  el.scanStop.onclick=stop;
  el.scanClear.onclick=async()=>{ await stop(); el.key.value=''; lastFicha=null; el.product.innerHTML=''; el.cantidad.value='1'; el.contarPor.value='u'; calcTotal(); el.key.focus(); };

  /* Registrar */
  el.enviar.onclick=()=>enviar(false);
  async function enviar(auto){
    const total=calcTotal();
    const payload={ mov: MOV.val, estado: el.estado.value, motivo:'', destino:'', key: el.key.value.trim(), cantidad: String(total), oc: el.oc.value.trim(), opi: el.opi.value.trim(), obs: el.obs.value.trim(), responsable: el.resp.value.trim() };
    if(!payload.key){ el.status.textContent='Ingrese/escanee C√≥digo/Modelo'; return; }
    if(!payload.responsable){ el.status.textContent='Seleccione Responsable'; return; }

    el.status.textContent = auto ? 'Registrando (auto)‚Ä¶' : 'Procesando‚Ä¶';
    const j = await apiPost(payload);
    if(j.ok){
      el.status.innerHTML = `‚úÖ ${j.Movimiento} ${j.Cantidad}u ‚Äî ${j.ficha.modelo} (${j.ficha.codigo}) ‚Äî Estado: ${j.Estado}${j.Dest?' ‚Üí '+j.Dest:''}. Saldo: ${j.saldo}`;
      if(auto){ el.cantidad.value='1'; el.key.value=''; lastFicha=null; el.product.innerHTML=''; calcTotal(); setLed('gray','Listo para siguiente'); }
      else     { el.cantidad.value='1'; el.obs.value=''; }
    } else {
      el.status.textContent = '‚ö†Ô∏è '+(j.error || 'Error inesperado') + (j.raw ? ' ¬∑ pista: '+ j.raw.replace(/\s+/g,' ').slice(0,80) : '');
    }
    if(auto && !scanning && AUTO) el.scanStart.click();
  }
  </script>
</body>
</html>
