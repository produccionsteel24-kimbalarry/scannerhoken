<!-- index.html en GitHub Pages -->
<meta name="robots" content="noindex,nofollow" />
<div id="app-root"></div>
<link rel="preconnect" href="https://unpkg.com" />
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
  :root{--gap:14px;--fg:#111;--muted:#666;--bd:#dcdcdc;--bg:#fafafa}
  *{box-sizing:border-box}
  body{font-family:system-ui,Segoe UI,Roboto,sans-serif;color:var(--fg);margin:0}
  .container{max-width:880px;margin:24px auto 64px;padding:0 16px}
  .card{background:var(--bg);border:1px solid var(--bd);border-radius:14px;padding:20px}
  .row{display:grid;grid-template-columns:1fr;gap:var(--gap);margin:0 0 var(--gap)}
  .two{grid-template-columns:1fr 1fr}
  @media(max-width:720px){.two{grid-template-columns:1fr}}

  label{font-size:14px;color:var(--muted)}
  input,select,textarea{width:100%;padding:12px;font-size:16px;border:1px solid var(--bd);border-radius:10px;background:#fff}
  textarea{min-height:84px;resize:vertical}

  .bar{display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap}
  .pillbar{display:flex;gap:10px}
  .pill,.toggle{padding:8px 14px;border-radius:999px;border:1px solid var(--bd);background:#fff;cursor:pointer;user-select:none}
  .pill.active,.toggle.active{background:#111;color:#fff;border-color:#111}
  .toggle-wrap{text-align:right;min-width:220px}
  .toggle-hint{display:block;margin-top:4px;font-size:12px;color:#666}

  #product{background:#fff;border:1px dashed var(--bd);border-radius:10px;padding:10px;font-size:14px;color:#333}
  #status{min-height:26px;font-size:15px;margin-top:6px}

  .actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
  button{padding:12px 18px;font-size:16px;border-radius:10px;border:1px solid #111;background:#111;color:#fff;cursor:pointer}
  button.secondary{background:#fff;color:#111}
  button:disabled{opacity:.6;cursor:not-allowed}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}

  #scanBar{display:flex;align-items:center;gap:10px;flex-wrap:wrap}

  /* Visor horizontal, contenido y centrado */
  #reader{
    width:100%;
    max-width:720px;      /* ancho m√°x del visor */
    aspect-ratio:16/9;    /* apaisado */
    border:1px solid var(--bd);
    border-radius:10px;
    background:#000;
    margin:0 auto;        /* centrado */
  }

  .led{width:12px;height:12px;border-radius:50%;border:1px solid #ccc;display:inline-block}
  .led.red{background:#e03a3a}.led.green{background:#19a34a}.led.gray{background:#bbb}
  .inline{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .muted{color:#666;font-size:14px}
  .alert{background:#ffe9e9;border:1px solid #ffb3b3;color:#9b1c1c;border-radius:10px;padding:10px;font-size:14px}
</style>

<script>
/* ========= API (Apps Script /exec) ========= */
const API = 'https://script.google.com/macros/s/AKfycbyrhccA9bA5fgjt8Y4vSF5tuwwAbMfPQxn8LRfkgx7JQsfu40EZN1mO84cVdFgIr-ohWg/exec';
/* ========================================== */

const $e = (sel,root=document)=>root.querySelector(sel);
const el = {};

/* UI */
document.getElementById('app-root').innerHTML = `
<div class="container"><div class="card">
  <h2>Sector Espera ‚Äì Movimientos</h2>

  <div class="bar">
    <div class="pillbar">
      <span class="pill" id="btnIng">Ingreso</span>
      <span class="pill" id="btnEgr">Egreso</span>
    </div>
    <div class="toggle-wrap">
      <span id="btnAuto" class="toggle" role="button" aria-pressed="false">Autom√°tico</span>
      <small class="toggle-hint">registrar al escanear</small>
    </div>
  </div>

  <div class="row two">
    <div>
      <label>Estado</label>
      <select id="estado">
        <option>Listo</option><option>Mecanizar</option><option>Rechazado</option><option>Reproceso</option>
      </select>
    </div>
    <div>
      <label>Responsable</label>
      <select id="resp"><option value="">-- Seleccionar --</option></select>
      <small id="respStatus" class="muted"></small>
    </div>
  </div>

  <div class="row" id="rowDestino" style="display:none">
    <div>
      <label>Destino mecanizado (si Mecanizar)</label>
      <select id="destino"><option>Bandas</option><option>Luj√°n</option></select>
    </div>
  </div>

  <div class="row" id="rowMotivo" style="display:none">
    <div>
      <label>Motivo (si Rechazado)</label>
      <select id="motivo">
        <option>Fuera de medida</option><option>Color</option>
        <option>Tornillos incorrectos</option><option>Otro</option>
      </select>
    </div>
  </div>

  <div class="row">
    <div>
      <label>C√≥digo o Modelo</label>
      <input id="key" placeholder="Escane√° o escrib√≠ el C√≥digo/Modelo" />
    </div>
  </div>

  <div class="row"><div id="product"></div></div>

  <div class="row">
    <div id="scanBar">
      <button class="secondary" id="scanStart">üì∑ Escanear</button>
      <button class="secondary" id="scanStop">‚úã Parar</button>
      <button class="secondary" id="scanClear">üóëÔ∏è Borrar</button>
      <span id="scanLed" class="led gray"></span>
      <small id="scanMsg" class="mono muted">C√°mara inactiva</small>
    </div>
    <div id="reader" style="display:none"></div>
  </div>

  <div class="row two">
    <div>
      <label>Contar por</label>
      <select id="contarPor"><option value="u">Unidades</option><option value="c">Cajas</option></select>
    </div>
    <div class="inline">
      <div style="flex:1">
        <label>Cantidad</label>
        <input id="cantidad" type="number" min="1" step="1" value="1" />
      </div>
      <div>
        <label>Total unidades</label>
        <input id="totalUnid" type="number" readonly value="1" />
      </div>
    </div>
  </div>

  <div class="row" id="alertUxCaja" style="display:none">
    <div class="alert">
      Este modelo no tiene <b>Unidades_por_caja</b> definido en <b>Maestros</b>.
      Cambi√° a <b>‚ÄúUnidades‚Äù</b> o defin√≠ el valor en la hoja. El modo <b>Autom√°tico</b> se desactiva.
    </div>
  </div>

  <div class="row"><div><label>OC (opcional)</label><input id="oc" /></div></div>
  <div class="row"><div><label>OPI (opcional)</label><input id="opi" /></div></div>
  <div class="row"><div><label>Observaciones (opcional)</label><textarea id="obs" rows="2"></textarea></div></div>

  <div class="row">
    <div class="actions"><button id="enviar">‚úì Registrar</button></div>
    <div id="status"></div>
  </div>
</div></div>
`;

const MOV = {val:'Ingreso'}; let AUTO=false, lastFicha=null, qr=null, scanning=false;
[
 'btnIng','btnEgr','btnAuto','estado','rowDestino','rowMotivo','key','product',
 'scanStart','scanStop','scanClear','scanLed','scanMsg','reader',
 'contarPor','cantidad','totalUnid','alertUxCaja','oc','opi','obs','resp','enviar','status','respStatus'
].forEach(id=>el[id]=$e('#'+id));

/* Movimiento */
function setMov(m){MOV.val=m; el.btnIng.classList.toggle('active',m==='Ingreso'); el.btnEgr.classList.toggle('active',m==='Egreso'); updCond();}
el.btnIng.onclick=()=>setMov('Ingreso'); el.btnEgr.onclick=()=>setMov('Egreso'); setMov('Ingreso');

/* Autom√°tico */
el.btnAuto.onclick=()=>{ if(el.btnAuto.classList.contains('disabled')) return; AUTO=!AUTO; el.btnAuto.classList.toggle('active',AUTO); el.btnAuto.setAttribute('aria-pressed',AUTO?'true':'false'); };

/* Condicionales por Estado */
el.estado.onchange=updCond;
function updCond(){
  const esRech=el.estado.value==='Rechazado', esMec=el.estado.value==='Mecanizar';
  el.rowMotivo.style.display=esRech?'':'none';
  el.rowDestino.style.display=esMec?'':'none';
}

/* Utilidades */
function disableAuto(dis,why=''){
  if(dis){ AUTO=false; el.btnAuto.classList.remove('active'); el.btnAuto.classList.add('disabled'); el.btnAuto.style.opacity=.6; el.btnAuto.title=why; }
  else   { el.btnAuto.classList.remove('disabled'); el.btnAuto.style.opacity=1;  el.btnAuto.title=''; }
}
function toggleAvisoUxCaja(show){ el.alertUxCaja.style.display=show?'':'none'; disableAuto(show,'Falta Unidades_por_caja para Cajas'); }
function calcTotal(){
  const modo=el.contarPor.value;
  const cant=Math.max(1,parseInt(el.cantidad.value||'1',10));
  const uxc=Number(lastFicha?.unidades_por_caja||0);
  let total=cant;
  if(modo==='c'){
    if(uxc>0){ total=cant*uxc; toggleAvisoUxCaja(false); }
    else     { toggleAvisoUxCaja(true); }
  } else toggleAvisoUxCaja(false);
  el.totalUnid.value=total; return total;
}
el.contarPor.onchange=calcTotal; el.cantidad.oninput=calcTotal;

/* ======== FETCH helpers con anti-cache ======== */
async function apiGet(url){
  const sep = url.includes('?') ? '&' : '?';
  const r = await fetch(url + sep + 'ts=' + Date.now());
  return r.json();
}
async function apiPost(body){
  const r = await fetch(API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
  return r.json();
}

/* Lookup por input */
let lookupTimer=null;
el.key.addEventListener('input',()=>{ clearTimeout(lookupTimer); lookupTimer=setTimeout(lookupProduct,200); });

async function lookupProduct(){
  const key=el.key.value.trim();
  if(!key){ el.product.innerHTML=''; lastFicha=null; calcTotal(); return; }
  el.product.textContent='Buscando‚Ä¶';
  const j=await apiGet(API+'?action=lookup&key='+encodeURIComponent(key));
  if(j.ok){
    lastFicha=j.ficha;
    const desc = j.ficha.descripcion ? `<br><b>Descripci√≥n:</b> ${j.ficha.descripcion}` : '';
    const uxc  = j.ficha.unidades_por_caja ? (' | U/Caja: '+j.ficha.unidades_por_caja) : '';
    el.product.innerHTML =
      `<small class="mono">
         Modelo: <b>${j.ficha.modelo}</b> | C√≥digo: <b>${j.ficha.codigo}</b><br>
         Material: ${j.ficha.material} | Color: ${j.ficha.color} | Medidas: ${j.ficha.medidas}${uxc}
         ${desc}
       </small>`;
  } else {
    lastFicha=null;
    el.product.innerHTML='<small style="color:#b00">No encontrado en Maestros</small>';
  }
  calcTotal();
}

/* ========= Poblar Responsables (anti-cache) ========= */
(async()=>{
  const info=(m)=>{ if(el.respStatus) el.respStatus.textContent=m||''; };
  try{
    info('Cargando responsables‚Ä¶');
    const u=await apiGet(API+'?action=users');
    if(u.ok && Array.isArray(u.responsables)){
      u.responsables.forEach(n=>{
        const o=document.createElement('option'); o.value=o.textContent=n; el.resp.appendChild(o);
      });
      info('');
    }else{
      info('No se recibieron responsables');
      console.warn('users ->', u);
    }
  }catch(err){
    info('No se pudo cargar responsables');
    console.error(err);
  }
})();

/* === Esc√°ner con marco apaisado y contenido === */
function setLed(state,msg){ el.scanLed.className='led '+(state||'gray'); el.scanMsg.textContent=msg||''; }

el.scanStart.onclick=async()=>{
  try{
    if(!qr) qr=new Html5Qrcode('reader');
    const cams=await Html5Qrcode.getCameras();
    const id=cams?.[0]?.id;
    if(!id){ setLed('red','Sin c√°mara'); return; }

    el.reader.style.display='';
    // ancho disponible y rect√°ngulo horizontal moderado
    const contW = Math.max(320, el.reader.clientWidth || 720);
    const qrW   = Math.min(Math.floor(contW * 0.78), 640); // ancho del marco
    const qrH   = Math.round(qrW * 0.36);                  // alto del marco

    await qr.start(
      id,
      { fps:10, qrbox:{ width:qrW, height:qrH }, videoConstraints:{ facingMode:'environment' } },
      async (txt)=>{
        el.key.value=txt.trim();
        await new Promise(r=>setTimeout(r,10));
        await lookupProduct();
        setLed('green','C√≥digo le√≠do');
        const aviso=el.alertUxCaja.style.display!=='none';
        if(AUTO && !aviso){ enviar(true); } else { await stop(); }
      },
      (err)=>{}
    );
    scanning=true; setLed('gray','Escaneando‚Ä¶');
  }catch(e){ setLed('red','No se pudo iniciar la c√°mara'); }
};

async function stop(){ try{ if(qr && scanning){ await qr.stop(); scanning=false;} }catch(e){} el.reader.style.display='none'; }
el.scanStop.onclick=stop;
el.scanClear.onclick=async()=>{ await stop(); el.key.value=''; lastFicha=null; el.product.innerHTML=''; el.cantidad.value='1'; el.contarPor.value='u'; calcTotal(); setLed('gray','C√°mara inactiva'); el.key.focus(); };

/* Registrar */
el.enviar.onclick=()=>enviar(false);
async function enviar(auto){
  const total=calcTotal();
  const payload={
    mov: MOV.val, estado: el.estado.value,
    motivo: (el.estado.value==='Rechazado') ? el.motivo.value : '',
    destino: (el.estado.value==='Mecanizar') ? el.destino.value : '',
    key: el.key.value.trim(), cantidad: String(total),
    oc: el.oc.value.trim(), opi: el.opi.value.trim(),
    obs: el.obs.value.trim(), responsable: el.resp.value.trim()
  };
  if(!payload.key){ el.status.textContent='Ingrese/escanee C√≥digo/Modelo'; return; }
  if(!payload.responsable){ el.status.textContent='Seleccione Responsable'; return; }

  el.status.textContent = auto ? 'Registrando (auto)‚Ä¶' : 'Procesando‚Ä¶';
  try{
    const j = await apiPost(payload);
    if(j.ok){
      el.status.innerHTML = `‚úÖ ${j.Movimiento} ${j.Cantidad}u ‚Äî ${j.ficha.modelo} (${j.ficha.codigo}) ‚Äî Estado: ${j.Estado}${j.Dest?' ‚Üí '+j.Dest:''}. Saldo: ${j.saldo}`;
      if(auto){ el.cantidad.value='1'; el.key.value=''; lastFicha=null; el.product.innerHTML=''; calcTotal(); setLed('gray','Listo para siguiente'); }
      else     { el.cantidad.value='1'; el.obs.value=''; }
    } else {
      el.status.textContent = '‚ö†Ô∏è '+(j.error||'Error inesperado');
    }
    if(auto && !scanning && AUTO) el.scanStart.click();
  }catch(err){
    el.status.textContent = '‚ùå '+err;
    if(auto) await stop();
  }
}
</script>
