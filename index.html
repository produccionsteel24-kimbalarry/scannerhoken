<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="robots" content="noindex,nofollow" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="preconnect" href="https://unpkg.com" />
  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    :root{--gap:14px;--fg:#111;--muted:#666;--bd:#dcdcdc;--bg:#fafafa}
    *{box-sizing:border-box}
    body{font-family:system-ui,Segoe UI,Roboto,sans-serif;color:var(--fg);margin:0}
    .container{max-width:880px;margin:24px auto 64px;padding:0 16px}
    .card{background:var(--bg);border:1px solid var(--bd);border-radius:14px;padding:20px}
    .row{display:grid;grid-template-columns:1fr;gap:var(--gap);margin:0 0 var(--gap)}
    .two{grid-template-columns:1fr 1fr}
    @media(max-width:720px){.two{grid-template-columns:1fr}}

    label{font-size:14px;color:var(--muted)}
    input,select,textarea{width:100%;padding:12px;font-size:16px;border:1px solid var(--bd);border-radius:10px;background:#fff}
    textarea{min-height:84px;resize:vertical}

    .pill,.toggle{padding:8px 14px;border-radius:999px;border:1px solid var(--bd);background:#fff;cursor:pointer;user-select:none}
    .pill.active,.toggle.active{background:#111;color:#fff;border-color:#111}

    .headerline{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:4px}
    .headerline h2{margin:0}
    .modebar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:6px 0 2px}
    .modehint{margin:0 0 10px;color:var(--muted);font-size:12px}

    #product{background:#fff;border:1px dashed var(--bd);border-radius:10px;padding:10px;font-size:14px;color:#333}
    #status{min-height:26px;font-size:15px;margin-top:6px}

    .actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    button{padding:12px 18px;font-size:16px;border-radius:10px;border:1px solid #111;background:#111;color:#fff;cursor:pointer}
    button.secondary{background:#fff;color:#111}
    button:disabled{opacity:.6;cursor:not-allowed}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}

    #scanBar{display:flex;align-items:center;gap:10px;flex-wrap:wrap}

    /* Contenedor del visor */
    #reader{
      position:relative;
      z-index:10;
      width:100%;
      max-width:720px;
      height:0;
      max-height:320px;
      overflow:hidden;
      border:1px solid var(--bd);
      border-radius:10px;
      background:#000;
      margin:8px auto 12px;
      display:none;
    }
    #reader,
    #reader #reader__scan_region,
    #reader video,
    #reader canvas,
    #reader .html5-qrcode-element,
    #reader #qr-shaded-region{
      display:block !important;
      width:100%  !important;
      height:100% !important;
    }
    #reader video{ object-fit:cover !important; }
    #reader__dashboard{ display:none !important; }

    @media (max-width:520px){ #reader{ max-width:100%; } }

    .led{width:12px;height:12px;border-radius:50%;border:1px solid #ccc;display:inline-block}
    .led.red{background:#e03a3a}.led.green{background:#19a34a}.led.gray{background:#bbb}
    .inline{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .muted{color:#666;font-size:14px}
    .alert{background:#ffe9e9;border:1px solid #ffb3b3;color:#9b1c1c;border-radius:10px;padding:10px;font-size:14px}
    .hint{color:#a33;font-size:12px;margin-top:6px}
    .badge{font-size:11px;padding:2px 6px;border-radius:6px;border:1px solid var(--bd);color:#555;margin-left:8px}

    .sep{height:1px;border:0;background:var(--bd);margin:14px 0}
    #recentTitle{margin:0;color:#333;font-size:14px}
    #recentList{list-style:none;padding:0;margin:8px 0 0}
    #recentList li{
      border:1px solid var(--bd);
      background:#fff;
      border-radius:10px;
      padding:8px 10px;
      margin-bottom:8px;
      font-size:13px;
      display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap
    }
    #recentList .left{display:flex;gap:8px;flex-wrap:wrap}
    #recentList .tag{font-size:11px;border:1px solid var(--bd);border-radius:999px;padding:2px 8px;color:#555;background:#fafafa}
    #recentList .ts{color:#777;font-size:11px}

    /* helpers de visibilidad */
    .hide{display:none}
  </style>
</head>
<body>
  <div id="app-root"></div>

  <script>
  /* ==== API (/exec) ==== */
  const API = 'https://script.google.com/macros/s/AKfycbwKn4L6psOtM778jC9rPrJt1tAzopLBEBs8asLiWLVRX9iFF6iIc3XpzLvsZfqsMsYiAw/exec';

  const $e = (sel,root=document)=>root.querySelector(sel);
  const el = {};
  document.getElementById('app-root').innerHTML = `
  <div class="container"><div class="card">

    <div class="headerline">
      <h2>Sector Espera ‚Äì Movimientos</h2>
      <span id="apiBadge" class="badge">API‚Ä¶</span>
    </div>

    <div class="modebar">
      <span class="pill" id="btnIng">Ingreso</span>
      <span class="pill" id="btnEgr">Egreso</span>
      <span id="btnAuto" class="toggle" role="button" aria-pressed="false">Autom√°tico</span>
    </div>
    <div class="modehint">
      Seleccion√° <b>Ingreso</b> o <b>Egreso</b> para registrar. Activ√° <b>Autom√°tico</b> si no requer√≠s carga manual de datos.
    </div>

    <div class="row two">
      <div>
        <label>Estado</label>
        <select id="estado">
          <option>Listo</option>
          <option>Mecanizar</option>
          <option>Rechazado</option>
          <option>Reproceso</option>
        </select>
      </div>
      <div>
        <label>Responsable</label>
        <select id="resp"><option value="">-- Seleccionar --</option></select>
        <div id="respError" class="hint" style="display:none"></div>
      </div>
    </div>

    <!-- Extras dependientes del estado -->
    <div class="row two hide" id="rowDestino">
      <div>
        <label>Destino mecanizado</label>
        <select id="destino">
          <option value="">-- Seleccionar --</option>
          <option value="Luj√°n">Luj√°n</option>
          <option value="Producci√≥n">Producci√≥n</option>
          <option value="Otro">Otro</option>
        </select>
      </div>
      <div id="boxDestOtro" class="hide">
        <label>Especificar destino (si elegiste ‚ÄúOtro‚Äù)</label>
        <input id="destinoOtro" placeholder="Escrib√≠ el destino" />
      </div>
    </div>

    <div class="row hide" id="rowMotivo">
      <div>
        <label>Motivo de rechazo</label>
        <select id="motivo">
          <option value="">-- Seleccionar --</option>
          <option>Color</option>
          <option>Rechupado</option>
          <option>Fuera de medida</option>
          <option>Contaminado</option>
          <option>Tornillos incorrectos</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <label>C√≥digo o Modelo</label>
        <input id="key"
               placeholder="Escane√° o escrib√≠ el C√≥digo/Modelo"
               autocapitalize="characters" autocorrect="off"
               autocomplete="off" spellcheck="false" inputmode="text" />
      </div>
    </div>

    <div class="row"><div id="product"></div></div>

    <div class="row">
      <div id="scanBar">
        <button class="secondary" id="scanStart">üì∑ Escanear</button>
        <button class="secondary" id="scanStop">‚úã Parar</button>
        <button class="secondary" id="scanClear">üóëÔ∏è Borrar</button>
        <span id="scanLed" class="led gray"></span>
        <small id="scanMsg" class="mono muted">C√°mara inactiva</small>
      </div>
      <div id="reader"></div>
    </div>

    <div class="row two">
      <div>
        <label>Contar por</label>
        <select id="contarPor"><option value="u">Unidades</option><option value="c">Cajas</option></select>
      </div>
      <div class="inline">
        <div style="flex:1"><label>Cantidad</label><input id="cantidad" type="number" min="1" step="1" value="1" /></div>
        <div><label>Total unidades</label><input id="totalUnid" type="number" readonly value="1" /></div>
      </div>
    </div>

    <div class="row" id="alertUxCaja" style="display:none">
      <div class="alert">Este modelo no tiene <b>Unidades_por_caja</b>. Cambi√° a <b>Unidades</b> o completalo en la hoja.</div>
    </div>

    <div class="row"><div><label>OC (opcional)</label><input id="oc" /></div></div>
    <div class="row"><div><label>OPI (opcional)</label><input id="opi" /></div></div>
    <div class="row"><div><label>Observaciones (opcional)</label><textarea id="obs" rows="2"></textarea></div></div>

    <div class="row">
      <div class="actions"><button id="enviar">‚úì Registrar</button></div>
      <div id="status"></div>
    </div>

    <hr class="sep" />
    <h3 id="recentTitle">√öltimos movimientos</h3>
    <ul id="recentList"></ul>

  </div></div>
  `;

  const MOV = {val:'Ingreso'}; let AUTO=false, lastFicha=null, qr=null, scanning=false;

  [
    'btnIng','btnEgr','btnAuto','estado','key','product','scanStart','scanStop','scanClear',
    'scanLed','scanMsg','reader','contarPor','cantidad','totalUnid','alertUxCaja','oc','opi','obs','resp','enviar','status','respError','apiBadge','recentList',
    'rowDestino','destino','destinoOtro','boxDestOtro','rowMotivo','motivo'
  ].forEach(id=>el[id]=$e('#'+id));

  /* Movimiento */
  function setMov(m){MOV.val=m; el.btnIng.classList.toggle('active',m==='Ingreso'); el.btnEgr.classList.toggle('active',m==='Egreso');}
  el.btnIng.onclick=()=>setMov('Ingreso'); el.btnEgr.onclick=()=>setMov('Egreso'); setMov('Ingreso');

  /* Autom√°tico */
  el.btnAuto.onclick=()=>{ if(el.btnAuto.classList.contains('disabled')) return; AUTO=!AUTO; el.btnAuto.classList.toggle('active',AUTO); el.btnAuto.setAttribute('aria-pressed',AUTO?'true':'false'); };

  /* Mostrar/ocultar extras seg√∫n estado */
  function syncExtras(){
    const est = el.estado.value;
    // Destino solo en Mecanizar
    el.rowDestino.classList.toggle('hide', est!=='Mecanizar');
    // Texto "Otro" solo si eligi√≥ Otro
    el.boxDestOtro.classList.toggle('hide', !(est==='Mecanizar' && el.destino.value==='Otro'));
    // Motivo solo en Rechazado
    el.rowMotivo.classList.toggle('hide', est!=='Rechazado');
  }
  el.estado.onchange = syncExtras;
  el.destino.onchange = syncExtras;
  syncExtras();

  /* Totales */
  function disableAuto(dis,why=''){ if(dis){AUTO=false; el.btnAuto.classList.remove('active'); el.btnAuto.classList.add('disabled'); el.btnAuto.style.opacity=.6; el.btnAuto.title=why;} else {el.btnAuto.classList.remove('disabled'); el.btnAuto.style.opacity=1; el.btnAuto.title='';}}
  function toggleAvisoUxCaja(show){ el.alertUxCaja.style.display=show?'':'none'; disableAuto(show,'Falta Unidades_por_caja'); }
  function calcTotal(){ const modo=el.contarPor.value, cant=Math.max(1,parseInt(el.cantidad.value||'1',10)); const uxc=Number(lastFicha&&lastFicha.unidades_por_caja||0); let total=cant; if(modo==='c'){ if(uxc>0){ total=cant*uxc; toggleAvisoUxCaja(false);} else { toggleAvisoUxCaja(true);} } else toggleAvisoUxCaja(false); el.totalUnid.value=total; return total; }
  el.contarPor.onchange=calcTotal; el.cantidad.oninput=calcTotal;

  /* ===== Fetch helpers (CORS + anti-cache) ===== */
  function antiCache(path){ return API + path + (path.indexOf('?')>-1?'&':'?') + 't=' + Date.now(); }

  async function apiGet(path){
    const r = await fetch(antiCache(path), { method: 'GET', mode: 'cors', cache: 'no-store', redirect: 'follow', headers: { 'Accept': 'application/json' } });
    const tx = await r.text();
    try { return JSON.parse(tx); } catch { return { ok:false, error:'NON_JSON', raw: tx.slice(0,200) }; }
  }

  /* POST con timeout + diagn√≥stico (evita preflight usando text/plain) */
  async function apiPost(body){
    const ctrl = new AbortController();
    const TIMEOUT_MS = 15000;
    const to = setTimeout(()=>ctrl.abort('timeout'), TIMEOUT_MS);

    let res, resText = '';
    try{
      res = await fetch(antiCache(''), {
        method: 'POST',
        mode: 'cors',
        cache: 'no-store',
        redirect: 'follow',
        headers: { 'Content-Type': 'text/plain;charset=utf-8', 'Accept': 'application/json' },
        body: JSON.stringify(body),
        signal: ctrl.signal
      });
      resText = await res.text();
    }catch(err){
      clearTimeout(to);
      return { ok:false, error: (err?.name==='AbortError' ? 'TIMEOUT' : 'NETWORK'), detail: String(err) };
    }
    clearTimeout(to);

    try{
      const j = JSON.parse(resText);
      j.httpStatus = res.status;
      return j;
    }catch(_){
      return { ok:false, error:'NON_JSON', httpStatus: res?.status, raw: resText.slice(0,300) };
    }
  }

  /* ====== √öltimos movimientos ====== */
  let recentMoves = [];
  function mapMoveFromApi(x){
    const ficha = x.ficha || {};
    return {
      ts: x.ts || x.timestamp || Date.now(),
      mov: x.mov || x.Movimiento || '',
      cant: x.cant || x.Cantidad || x.cantidad || '',
      modelo: x.modelo || ficha.modelo || '',
      codigo: x.codigo || ficha.codigo || '',
      estado: x.estado || x.Estado || ''
    };
  }
  async function fetchRecent(){
    let j = await apiGet('?action=recent&limit=5').catch(()=>null);
    if(!j || !j.ok) j = await apiGet('?action=ultimos&n=5').catch(()=>null);
    if(j && j.ok && Array.isArray(j.items || j.data || j.rows)){
      const arr = (j.items || j.data || j.rows).map(mapMoveFromApi);
      recentMoves = arr.slice(0,5); renderRecent();
      try{ sessionStorage.setItem('recentMoves', JSON.stringify(recentMoves)); }catch(_){}
      return true;
    }
    return false;
  }
  function fmtTs(ts){ try{const d=new Date(ts);const dd=d.toLocaleDateString(undefined,{day:'2-digit',month:'2-digit'});const hh=d.toLocaleTimeString(undefined,{hour:'2-digit',minute:'2-digit'});return dd+' '+hh;}catch(_){return '';} }
  function renderRecent(){
    el.recentList.innerHTML = '';
    (recentMoves||[]).slice(0,5).forEach(m=>{
      const li = document.createElement('li');
      li.innerHTML = `<div class="left">
           <span class="tag">${m.mov}</span>
           <span><b>${m.cant}u</b> ‚Äî ${m.modelo} (<span class="mono">${m.codigo}</span>)</span>
           <span class="tag">Estado: ${m.estado}</span>
         </div>
         <span class="ts">${fmtTs(m.ts)}</span>`;
      el.recentList.appendChild(li);
    });
  }
  function addRecentLocal(m){
    try{
      const saved = JSON.parse(sessionStorage.getItem('recentMoves') || '[]');
      const list = [m, ...saved].slice(0,5);
      sessionStorage.setItem('recentMoves', JSON.stringify(list));
      recentMoves = list; renderRecent();
    }catch(_){}
  }

  /* ====== Saldo para Egreso (opcional si el backend lo provee) ====== */
  async function getSaldo(key) {
    try {
      let r = await apiGet('?action=saldo&key=' + encodeURIComponent(key));
      if (r && r.ok && typeof r.saldo === 'number') return r.saldo;
      r = await apiGet('?action=lookup&key=' + encodeURIComponent(key));
      if (r && r.ok && r.ficha && typeof r.ficha.saldo === 'number') return r.ficha.saldo;
      return null;
    } catch (_) { return null; }
  }

  /* Ping + responsables + √∫ltimos */
  (async ()=>{
    const ping = await apiGet('?action=ping');
    const ok = ping && ping.ok;
    el.apiBadge.textContent = ok ? 'API OK' : 'API ERROR';
    el.apiBadge.style.color = ok ? '#0a0' : '#a00';

    const u = await apiGet('?action=users');
    if(u && u.ok && Array.isArray(u.responsables)){
      u.responsables.forEach(n=>{ const o=document.createElement('option'); o.value=o.textContent=n; el.resp.appendChild(o); });
      el.respError.style.display='none';
    }else{
      el.respError.style.display=''; const err=(u&&u.error)?(' ('+u.error+')'):'';
      const raw=(u&&u.raw)?(' ¬∑ pista: '+u.raw.replace(/\s+/g,' ').slice(0,80)):'';
      el.respError.textContent='No se pudo cargar responsables'+err+raw;
    }

    const okRecent = await fetchRecent();
    if(!okRecent){
      try{ recentMoves = JSON.parse(sessionStorage.getItem('recentMoves')||'[]'); }catch(_){ recentMoves = []; }
      renderRecent();
    }
  })();

  /* Lookup producto */
  let lookupTimer=null;
  el.key.addEventListener('input',()=>{ clearTimeout(lookupTimer); lookupTimer=setTimeout(lookupProduct,200); });
  async function lookupProduct(){
    const key=(el.key.value||'').trim();
    if(!key){ el.product.innerHTML=''; lastFicha=null; calcTotal(); return; }
    el.product.textContent='Buscando‚Ä¶';
    const j=await apiGet('?action=lookup&key='+encodeURIComponent(key));
    if(j && j.ok){
      lastFicha=j.ficha;
      const desc = j.ficha.descripcion ? '<br><b>Descripci√≥n:</b> '+j.ficha.descripcion : '';
      const uxc  = j.ficha.unidades_por_caja ? (' | U/Caja: '+j.ficha.unidades_por_caja) : '';
      el.product.innerHTML =
        '<small class="mono">Modelo: <b>'+j.ficha.modelo+
        '</b> | C√≥digo: <b>'+j.ficha.codigo+
        '</b><br>Material: '+j.ficha.material+
        ' | Color: '+j.ficha.color+
        ' | Medidas: '+j.ficha.medidas+uxc+desc+'</small>';
    } else {
      lastFicha=null;
      el.product.innerHTML = '<small style="color:#b00">No encontrado en Maestros</small>';
    }
    calcTotal();
  }

  /* ===== C√ÅMARA (QR) (sin cambios) ===== */
  function setLed(state,msg){ el.scanLed.className='led '+(state||'gray'); el.scanMsg.textContent=msg||''; }
  function pickCodeFromText(raw){
    if(!raw) return ''; const U=String(raw).toUpperCase();
    const hy=[...U.matchAll(/\b[A-Z0-9]+(?:-[A-Z0-9]+){1,}\b/g)].map(m=>m[0]);
    if(hy.length){ hy.sort((a,b)=>b.length-a.length); return hy[0]; }
    const m=U.match(/\b[A-Z0-9]{3,}\b/); return m?m[0]:U.trim();
  }
  function vibrate(msOrPattern){ if('vibrate' in navigator){ try{ navigator.vibrate(msOrPattern);}catch(_){}} }
  function onScan(txt){ (async()=>{ const code=pickCodeFromText(txt); el.key.value=code; vibrate(40); await new Promise(r=>setTimeout(r,10)); await lookupProduct(); setLed('green','C√≥digo le√≠do'); if (AUTO) { enviar(true); } })(); }
  function onError(_) {}
  async function fixVideoOnce(){
    for(let i=0;i<30;i++){
      const v=el.reader.querySelector('video');
      if(v){ try{ v.setAttribute('playsinline',''); v.muted=true; v.style.width='100%'; v.style.height='100%'; v.style.objectFit='cover'; }catch(e){} return; }
      await new Promise(r=>setTimeout(r,100));
    }
  }
  el.scanStart.onclick = async function () {
    try{
      const cardW = el.reader.parentElement.getBoundingClientRect().width || 720;
      const contW = Math.max(320, Math.min(cardW, 720));
      const isPhone = window.matchMedia('(max-width: 520px)').matches;
      const h = isPhone ? Math.min(200, Math.max(120, Math.floor(contW * 0.45)))
                        : Math.min(260, Math.max(160, Math.floor(contW * 0.60)));
      const box = Math.floor(Math.min(h, contW) * (isPhone ? 0.78 : 0.85));
      el.reader.style.display=''; el.reader.style.width=contW+'px'; el.reader.style.height=h+'px';
      if(qr){ try{ await qr.stop(); await qr.clear(); }catch(e){} } el.reader.innerHTML='';
      qr = new Html5Qrcode('reader', { verbose:false }); setLed('gray','Solicitando c√°mara‚Ä¶');
      const cams = await Html5Qrcode.getCameras(); if(!cams || !cams.length){ setLed('red','No se encontr√≥ c√°mara'); await stop(); return; }
      const back = cams.find(c=>/back|rear|environment|trasera/i.test(c.label||'')) || cams[0];
      const startConfig = { fps:12, qrbox:{width:box,height:box}, videoConstraints:{facingMode:'environment'} };
      if(window.Html5QrcodeSupportedFormats && Html5QrcodeSupportedFormats.QR_CODE){ startConfig.formatsToSupport=[Html5QrcodeSupportedFormats.QR_CODE]; }
      await qr.start({ deviceId:{ exact: back.id || back } }, startConfig, onScan, onError);
      scanning=true; setLed('gray','Escaneando‚Ä¶'); await fixVideoOnce();
    }catch(e){ setLed('red','No se pudo iniciar la c√°mara'); await stop(); }
  };
  async function stop(){ try{ if(qr && scanning){ await qr.stop(); } if(qr){ await qr.clear(); } scanning=false; }catch(e){} el.reader.style.height='0px'; el.reader.style.display='none'; setLed('gray','C√°mara inactiva'); }
  el.scanStop.onclick=stop;
  el.scanClear.onclick=async function(){ await stop(); el.key.value=''; lastFicha=null; el.product.innerHTML=''; el.cantidad.value='1'; el.contarPor.value='u'; calcTotal(); el.key.focus(); };

  /* Registrar */
  el.enviar.onclick=function(){enviar(false)};
  async function enviar(auto){
    const total=calcTotal();
    // armo destino/motivo seg√∫n estado
    let destino = '', motivo = '';
    if(el.estado.value==='Mecanizar'){
      destino = el.destino.value==='Otro' ? (el.destinoOtro.value||'').trim() : el.destino.value;
      if(!destino){ el.status.textContent='Eleg√≠ el destino de mecanizado'; return; }
    }
    if(el.estado.value==='Rechazado'){
      motivo = el.motivo.value || '';
      if(!motivo){ el.status.textContent='Eleg√≠ el motivo de rechazo'; return; }
    }

    const payload={
      mov: MOV.val,
      estado: el.estado.value,
      motivo,
      destino,
      key: el.key.value.trim(),
      cantidad: String(total),
      oc: el.oc.value.trim(),
      opi: el.opi.value.trim(),
      obs: el.obs.value.trim(),
      responsable: el.resp.value.trim()
    };
    if(!payload.key){ el.status.textContent='Ingrese/escanee C√≥digo/Modelo'; return; }
    if(!payload.responsable){ el.status.textContent='Seleccione Responsable'; return; }

    if (payload.mov === 'Egreso') {
      const saldo = await getSaldo(payload.key);
      if (typeof saldo === 'number' && total > saldo) {
        el.status.style.color = '#a00';
        el.status.textContent = '‚ö†Ô∏è No hay saldo suficiente. Disponible: '+saldo+'u ¬∑ Solicitado: '+total+'u';
        vibrate([20,30,20]); return;
      }
    }

    el.status.style.color = '#333';
    el.status.textContent = auto ? 'Registrando (auto)‚Ä¶' : 'Procesando‚Ä¶';

    const j = await apiPost(payload);

    if(j && j.ok){
      el.status.style.color = '#111';
      el.status.innerHTML = '‚úÖ '+j.Movimiento+' '+j.Cantidad+'u ‚Äî '+j.ficha.modelo+' ('+j.ficha.codigo+') ‚Äî Estado: '+j.Estado+(j.Dest?' ‚Üí '+j.Dest:'')+'. Saldo: '+j.saldo;
      vibrate([30,40,30]);
      addRecentLocal({ ts:Date.now(), mov:j.Movimiento, cant:j.Cantidad, modelo:j.ficha.modelo, codigo:j.ficha.codigo, estado:j.Estado });
      fetchRecent();
      if(auto){
        el.cantidad.value='1'; el.key.value=''; lastFicha=null; el.product.innerHTML=''; calcTotal(); setLed('gray','Listo para siguiente');
      } else {
        el.cantidad.value='1'; el.obs.value='';
      }
      // limpiar selects dependientes para pr√≥ximo registro
      el.destino.value=''; el.destinoOtro.value=''; el.motivo.value=''; syncExtras();
    } else {
      let extra=''; if(j && j.httpStatus) extra+=' ¬∑ status: '+j.httpStatus; if(j && j.raw) extra+=' ¬∑ pista: '+j.raw.replace(/\s+/g,' ').slice(0,80);
      el.status.style.color='#a00'; el.status.textContent='‚ö†Ô∏è '+(j && j.error ? j.error : 'Error inesperado')+extra;
    }

    if(auto && !scanning && AUTO) el.scanStart.click();
  }
  </script>
</body>
</html>
